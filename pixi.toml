[workspace]
channels = ["https://prefix.dev/conda-forge"]
platforms = ["linux-64", "osx-arm64", "osx-64"]
preview = ["pixi-build"]

# -------------------------------
# === Packaging Configuration ===
# -------------------------------
[package]
version = "dynamic" # Until pixi recommends something else

[package.build]
backend = { name = "pixi-build-python", version = "*" }

[package.build.config]
noarch = false

[workspace.build-variants]
python = ["3.10.*", "3.11.*", "3.12.*", "3.13.*"]

[package.host-dependencies]
uv = "*"
python = "*"
hatchling = "*"
hatch-vcs = "*"
hatch-cython = ">=0.6.0rc0"
cython = ">=3.1,<4"
llvm-openmp = "*"
cherab = "1.5.*"

[package.run-dependencies]
imas-python = "*"
typing-extensions = ">=4.5"

# ---------------------------------
# === Development Configuration ===
# ---------------------------------
[dependencies]
cherab-imas = { path = "." }
ipython = "*"
pooch = "*"
rich = "*"

[tasks]
ipython = { cmd = "ipython", description = "ðŸ Start an IPython shell" }

# === Testing feature ===
[feature.test.dependencies]
pytest = "*"
pytest-cov = "*"

[feature.test.tasks]
test = { cmd = ["pytest", "tests"], description = "ðŸ§ª Run the tests" }

# === Docs feature ===
[feature.docs.dependencies]
sphinx = ">=7,<8.2"
sphinx-copybutton = "*"
sphinx-codeautolink = "*"
sphinx-design = "*"
sphinx-immaterial = "*"
linkify-it-py = "*"
myst-parser = "*"
# For notebook support
ipykernel = "*"
ipywidgets = "*"
nbsphinx = "*"
pandoc = "*"

[feature.docs.pypi-dependencies]
sphinx-github-style = "*"
sphinx-api-relink = "*"

[feature.docs.tasks]
doc-build = { cmd = [
  "sphinx-build",
  "-b",
  "{{ target }}",
  "-j",
  "auto",
  "source",
  "build/{{ target }}",
], cwd = "docs", args = [
  { arg = "target", default = "html" },
], description = "ðŸ“ Build the docs" }
doc-clean = { cmd = [
  "rm",
  "-rf",
  "build",
  "source/_api",
], cwd = "docs", description = "ðŸ”¥ Clean the docs build & api directory" }
doc-serve = { cmd = [
  "python",
  "-m",
  "http.server",
  "8000",
  "--directory",
  "build/html",
], cwd = "docs", description = "ðŸš€ Start a local server for the docs" }

# === Linting feature ===
[feature.lint.dependencies]
dprint = "*"
lefthook = "*"
ruff = "*"
typos = "*"
mypy = "*"
basedpyright = "*"
actionlint = "*"
shellcheck = "*"
validate-pyproject = "*"
cython-lint = "*"
blacken-docs = "*"
taplo = "*"

[feature.lint.tasks]
lefthook = { cmd = "lefthook", description = "ðŸ”— Run lefthook" }
hooks = { cmd = "lefthook install", description = "ðŸ”— Install pre-commit hooks" }
pre-commit = { cmd = "lefthook run pre-commit", description = "ðŸ”— Run pre-commit checks" }
mypy = { cmd = "mypy", description = "Type check with mypy" }
pyright = { cmd = "basedpyright", description = "Type check with basedpyright" }
ruff-check = { cmd = "ruff check --fix", description = "Lint with ruff" }
ruff-format = { cmd = "ruff format", description = "Format with ruff" }
dprint = { cmd = "dprint fmt", description = "Format with dprint" }
typos = { cmd = "typos --write-changes --force-exclude", description = "Fix typos" }
taplo = { cmd = "taplo fmt", description = "Format toml files with taplo" }
actionlint = { cmd = "actionlint", description = "Lint actions with actionlint" }
blacken-docs = { cmd = "blacken-docs", description = "Format Python markdown blocks with Black" }
validate-pyproject = { cmd = "validate-pyproject pyproject.toml", description = "Validate pyproject.toml" }
cython-lint = { cmd = "cython-lint", description = "Lint Cython files" }
lint = { cmd = "lefthook run pre-commit --all-files --force", description = "ðŸ§¹ Run all linters" }

# Clean build artifacts
clean = { cmd = "find src -type f \\( -name '*.c' -o -name '*.so' -o -name '*.pyd' -o -name '*.dll' \\) -delete", description = "ðŸ§¹ Clean build artifacts" }

# === Python environment features ===
[feature.py310.dependencies]
python = "3.10.*"
[feature.py313.dependencies]
python = "3.13.*"

[environments]
default = { features = ["py313"], solve-group = "py313" }
docs = { features = ["py313", "docs"], solve-group = "py313" }
test = { features = ["py313", "test"], solve-group = "py313" }
test-py313 = { features = [
  "py313",
  "test",
], solve-group = "py313" } # alias of test
test-py310 = ["py310", "test"]
lint = { features = ["lint"], no-default-feature = true }
