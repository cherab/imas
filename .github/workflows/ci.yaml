name: CI

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v5

      - name: ğŸŸ¨ Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.2
        with:
          environments: lint

      - name: ğŸ§¹ Execute lint
        run: pixi run -e lint lint

  checks:
    name: Test ğŸ ${{ matrix.environment }} on ${{ startsWith(matrix.os, 'macos-') && 'macOS' || startsWith(matrix.os, 'windows-') && 'Windows' || 'Linux' }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        environment: [test-py310, test-py313]
    runs-on: ${{ matrix.os }}

    steps:
      - name: check out repo
        uses: actions/checkout@v5

      - name: ğŸŸ¨ Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.2
        with:
          environments: ${{ matrix.environment }}

      - name: ğŸ§ª Execute pytest
        env:
          pytest_github_report: true
        run: pixi run -e ${{ matrix.environment }} test --cov-report xml

      - name: ğŸ“¦ Disambiguate coverage filename by environment and OS
        run: mv .coverage ".coverage.${{ matrix.environment }}.${{ matrix.os }}.xml"

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
